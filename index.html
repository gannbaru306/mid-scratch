<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>MIDI to Scratch by gannbaru306</title>
  </head>
<body>
  <h2>MIDI変換ツール</h2>
  <input type="file" id="midiFile" accept=".mid,.midi" />
  <button id="convertBtn">変換してダウンロード</button>
  <pre id="log"></pre>

  <script type="module">
    import { Midi } from "https://cdn.skypack.dev/@tonejs/midi";

const gmToScratchId = gm => {
  if (gm < 4) return 1;
  if (gm < 7) return 2;
  if (gm < 12) return 17;
  if (gm === 12) return 16;
  if (gm === 13) return 19;
  if (gm === 14) return 16;
  if (gm === 15) return 17;
  if (gm < 20) return 3;
  if (gm < 24) return 6;
  if (gm < 27) return 4;
  if (gm < 32) return 5;
  if (gm < 40) return 6;
  if (gm < 48) return 8;
  if (gm < 52) return 15;
  if (gm < 56) return 11;
  if (gm < 60) return 9;
  if (gm < 65) return 10;
  if (gm < 68) return 11;
  if (gm < 72) return 14;
  if (gm < 75) return 12;
  if (gm < 77) return 13;
  if (gm < 80) return 13;
  if (gm < 88) return 20;
  if (gm < 96) return 21;
  if (gm < 104) return 20;
  if (gm < 112) return 16;
  if (gm < 120) return 18;
  if (gm < 128) return 0;
  return 1;
};

    const midiToScratchDrum = {
      38: 1, 36: 2, 35: 2, 37: 3, 49: 4, 46: 5, 42: 6,
      54: 7, 39: 8, 75: 9, 76: 10, 56: 11, 81: 12,
      60: 13, 63: 14, 69: 15, 67: 16, 58: 17, 72: 18,
      40: 1, 41: 1, 55: 18
    };
    Object.assign(midiToScratchDrum, {
  27: 2,
  43: 2,
  44: 6,
  45: 2,
  47: 2,
  48: 2,
  50: 9,
  51: 4,
  57: 4
});


    const normalizeVelocity = v => Math.max(Math.round(v * 100), 10);
    const sanitizeLabel = text => text.toLowerCase().replace(/[^a-z0-9]/g, '');

    document.getElementById("convertBtn").addEventListener("click", async () => {
      const fileInput = document.getElementById("midiFile");
      const file = fileInput.files[0];
      if (!file) return alert("MIDIファイルを選択してください");

      const arrayBuffer = await file.arrayBuffer();
      const midi = new Midi(arrayBuffer);
      const ticksPerBeat = midi.header.ppq;
      const bpm = midi.header.tempos[0]?.bpm || 150;
      const secondsPerBeat = 60 / bpm;
      const ticksToSeconds = ticks => (ticks / ticksPerBeat) * secondsPerBeat;

      const trackNotes = {};
      midi.tracks.forEach((track, i) => {
        const labelRaw = track.name || `Track${i + 1}`;
        const label = `${labelRaw}_Track${i + 1}`;
        const normalizedLabel = sanitizeLabel(label);
        const programNumber = track.instrument?.number ?? null;

        let scratchId = undefined;
        for (const name in customInstruments) {
          if (normalizedLabel.includes(sanitizeLabel(name))) {
            scratchId = customInstruments[name];
            break;
          }
        }
        if (!scratchId && programNumber !== null) {
          scratchId = gmToScratchId(programNumber);
        }

        const isDrum = track.instrument?.family === "drums" || track.instrument?.number === 128;
        const noteList = [];

        track.notes.forEach(note => {
          const startFrame = Math.round(note.time * 30);
          const durationBeats = note.duration / secondsPerBeat;
          const volume = normalizeVelocity(note.velocity);

          if (isDrum) {
            const drumId = midiToScratchDrum[note.midi];
            if (drumId) {
              if (!trackNotes["drums"]) {
                trackNotes["drums"] = { scratch_id: 0, notes: [] };
              }
              trackNotes["drums"].notes.push([drumId, startFrame, durationBeats, volume]);
            }
          } else {
            noteList.push([note.midi, startFrame, durationBeats, volume]);
          }
        });

        if (!isDrum && noteList.length > 0) {
          trackNotes[label] = { scratch_id: scratchId, notes: noteList };
        }
      });
     const log = document.getElementById("log"); // ← ここを先に定義

// ドラム未定義ノート収集
const undefinedDrumNotes = new Set();
midi.tracks.forEach(track => {
  const isDrum = track.instrument?.family === "drums" || track.instrument?.number === 128;
  if (isDrum) {
    track.notes.forEach(note => {
      const drumId = midiToScratchDrum[note.midi];
      if (!drumId) {
        undefinedDrumNotes.add(note.midi);
      }
    });
  }
});

if (undefinedDrumNotes.size > 0) {
  log.textContent += "\n以下の内容をgannbaru306のMIDI再生プログラムに貼り付けてください。ドラムが正しく認識されませんでした。\n";
  [...undefinedDrumNotes].sort((a, b) => a - b).forEach(midiNote => {
    log.textContent += `${midiNote}\n`;
  });
}

log.textContent += "\n変換完了！ノート数:\n"; // ← += に変更
Object.entries(trackNotes).forEach(([label, data]) => {
  log.textContent += `${label}: ${data.notes.length} notes\n`;
});
      
      const timestamp = new Date().toISOString().replace(/[-:T]/g, "").slice(0, 15);
      const lines = [];

      // 楽器IDリスト
      for (const [label, data] of Object.entries(trackNotes)) {
        if (data.notes.length > 0) {
          lines.push(`${data.scratch_id}`);
        }
      }
      lines.push("/");

      // ノート情報
      for (const [label, data] of Object.entries(trackNotes)) {
        if (data.notes.length > 0) {
          data.notes.forEach(([note, frame, beats, volume]) => {
            lines.push(`${note}/${frame}/${beats.toFixed(2)}/${volume}`);
          });
          lines.push("/");
        }
      }
      const blob = new Blob([lines.join("\n")], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `combined_notes_${timestamp}.txt`;
      link.click();
    });

    // カスタム楽器名 → Scratch ID
    const customInstruments = {
      "8-bit square": 21,
      "8-bit sawtooth": 20,
      "NES triangle": 6,
      "FM bell": 16,
      "ambient pad": 21,
      "square lead": 21,
      "saw lead": 20,
      "triangle wave": 6,
      "pulse wave": 21,
      "chip bass": 6,
      "chip lead": 20,
      "retro pad": 21,
      "vox": 15,
      "voice": 15,
      "pluck": 4,
      "synth brass": 9,
      "synth flute": 12,
      "synth choir": 15,
      "bit crash": 21,
      "glitch": 21,
      "laser": 20,
      "noise": 0,
      "french horn": 9,
      "english horn": 10,
      "synth horn": 20,
      "ambient horn": 21,
      "retro horn": 20,
      "brass horn": 9
    };
  </script>
</body>
</html>
